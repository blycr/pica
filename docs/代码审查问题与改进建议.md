# 代码审查问题与改进建议

## 1. 文档不一致性
- [已修复] **README 与 项目概览** 中仍然列出 “评分系统” 为已实现功能，但在实际代码中评分系统的实现仍有细节缺失（如删除最后一个评分后 `rating_count` 未同步为 0）。
- [已修复] **待办事项.md** 中的 “历史记录与收藏夹” 已标记为完成，但前端仍未真正对接真实数据，导致首页展示的 “继续阅读/收藏” 为空。（已更新待办事项状态）
- [已修复] **技术与架构.md** 中的数据库设计缺少 `rating` 与 `rating_count` 字段的说明，导致文档与实际表结构不匹配。
- [无需修复] **技术方案思路.md** 中提到的 PIN 码认证方案未在前端实现对应 UI，导致后端接口不可用。（已在待办事项中列为 P1 任务）

## 2. 潜在性能问题
- [暂未修复] `server/routes/manga.js` 中对每个漫画列表请求都使用 `path.relative(process.cwd(), ...)` 进行路径转换，建议在数据库中直接存储相对路径以避免每次请求的计算开销。
- [已修复] `GET /api/manga/:id/chapters/:chapterId/pages` 使用同步的 `fs.readdirSync` 读取章节目录，可能在章节图片数量较多时阻塞事件循环。建议改为异步 `fs.promises.readdir` 并使用 `await`。
- [已修复] `server/routes/search.js` 的高级搜索在标签过滤时未对 `tags` 参数进行去重，可能导致重复的 JOIN 导致查询慢。

## 3. 安全考虑
- [已修复] `/api/image`（或 `server/routes/image.js`）的路径安全检查仅使用 `path.isAbsolute` 与 `path.resolve`，仍可能被构造路径遍历。建议使用白名单或严格限制在 `MANGA_LIBRARY_PATH` 范围内。
- [已修复] 配置写回 API (`/api/config/env`) 直接写入 `.env`，缺少对敏感变量的过滤，可能导致泄露或意外修改关键环境变量（如 `NODE_ENV`、`PORT`）。

## 4. 代码可读性 / 维护性
- [已修复] `server/routes/ratings.js` 在删除评分后使用 `COALESCE(AVG(rating), 0)` 计算平均值，但未同步 `rating_count` 为 0，导致统计不一致。建议在删除后显式设置 `rating_count = 0` 当没有评分记录时。
- [已修复] `server/utils/scanner.js` 中的 `extractChapterNumber` 正则仅匹配第一个数字，若章节文件名包含多个数字（如 `第12话 第3卷`）会导致排序错误。可改为提取最后一个数字或使用更复杂的规则。

## 5. 其他建议
- [TodoList] 为 `GET /api/manga/:id/chapters/:chapterId/pages` 添加分页或流式读取，以防一次性返回大量图片导致响应体过大。
- [TodoList] 在前端阅读器实现图片懒加载（已部分实现）时，加入 `IntersectionObserver` 进一步提升性能。
- [TodoList] 为 `POST /api/config/json` 增加 JSON Schema 校验，防止非法配置写入导致系统异常。
- [TodoList] 在 `README.md` 与文档中统一使用 “P0/P1/P2” 标记的任务状态，避免出现已完成却仍在 Todo 列表中的情况。

---
*此文档基于当前代码审查生成，后续可根据实际修复情况进行更新。*
