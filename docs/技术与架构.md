# 技术与架构

## 项目架构图
```text
[浏览器前端] <--> [Vite Dev Server (Port 5173)]
      ^
      | HTTP/REST API
      v
[Express 后端 (Port 3000)] <--> [文件扫描器]
      |                              |
      |                              v
      +---> [SQLite 数据库] <--- [本地漫画文件系统]
            (缓存/元数据)
```

## 核心模块功能说明

### 1. Frontend (Vite + Tailwind)
- 采用响应式设计基础 (注：移动端深度适配在 P0 计划中)
- 使用 `glass` 类实现磨砂玻璃质感设计
- 界面目前默认为深色模式 (注：白天模式切换在 P0 计划中)
- 通过 REST API 与后端通信

### 2. Backend (Express + Node.js)
- **端口**: 3000
- **路由模块**:
  - `/api/manga` - 漫画管理
  - `/api/tags` - 标签系统
  - `/api/scanner` - 文件扫描
  - `/api/thumbnails` - 缩略图管理
  - `/api/search` - 搜索
  - `/api/libraries` - 书库管理
  - `/api/metadata` - 元数据管理
  - `/api/history` - 阅读历史
- **中间件**: CORS、JSON 解析、错误处理

### 3. Database (SQLite + better-sqlite3)
- **性能优化**: WAL 模式、索引优化
- **表结构**: 详见下方[数据库设计](#数据库设计)章节

### 4. Scanner (文件扫描器)
- 支持多种目录结构：封面 + 章节目录、单卷漫画（直接存图）
- 支持中日韩字符、Emoji 及复杂目录层级
- 自动提取封面、章节、页数

### 5. Search & Optimization (核心增强)
- **高级搜索**: 支持多标签组合筛选、防抖实时搜索。
- **缩略图系统**: 集成 Sharp 实现 WebP 高效转换与三级尺寸缓存。
- **性能**: 图像懒加载、页面级预加载（Next Chapter）。

### 6. Viewer (已完善)
- **沉浸式阅读**: 自动隐藏工具栏，适配移动端和桌面端。
- **交互**: 支持键盘快捷键 (`←/→`) 和移动端手势（双击缩放、边缘侧滑返回）。

---

## 数据库设计

### 表结构概览

#### 1. manga (漫画表)
存储漫画的基本信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| library_id | INTEGER | 书库 ID (Foreign Key) |
| title | TEXT | 漫画标题 |
| path | TEXT | 漫画目录路径（唯一） |
| cover_path | TEXT | 封面图片路径 |
| total_chapters | INTEGER | 总章节数 |
| total_pages | INTEGER | 总页数 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |
| last_read_at | DATETIME | 最后阅读时间 |
| is_favorite | BOOLEAN | 是否收藏 |

#### 2. chapters (章节表)
存储每个漫画的章节信息。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| manga_id | INTEGER | 关联的漫画 ID |
| chapter_number | INTEGER | 章节号 |
| title | TEXT | 章节标题 |
| path | TEXT | 章节目录路径 |
| page_count | INTEGER | 页数 |
| created_at | DATETIME | 创建时间 |

**约束**: `(manga_id, chapter_number)` 唯一

#### 3. tags (标签表)
存储所有可用的标签。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| name | TEXT | 标签名称（唯一） |
| color | TEXT | 标签颜色（HEX） |
| created_at | DATETIME | 创建时间 |

#### 4. manga_tags (漫画-标签关联表)
多对多关系表，关联漫画和标签。

| 字段 | 类型 | 说明 |
|------|------|------|
| manga_id | INTEGER | 漫画 ID |
| tag_id | INTEGER | 标签 ID |
| created_at | DATETIME | 创建时间 |

**主键**: `(manga_id, tag_id)`

#### 5. reading_history (阅读历史表)
记录用户的阅读进度。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| manga_id | INTEGER | 漫画 ID |
| chapter_id | INTEGER | 章节 ID |
| page_number | INTEGER | 当前页码 |
| progress | REAL | 阅读进度（0-1） |
| read_at | DATETIME | 阅读时间 |

#### 6. libraries (书库表)
支持多书库管理。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键，自增 |
| name | TEXT | 书库名称 |
| path | TEXT | 物理路径 |
| description | TEXT | 描述 |
| is_active | BOOLEAN | 是否激活 |

### 索引优化

为提升查询性能，创建了以下索引：
- `idx_manga_title`: 漫画标题索引（支持快速搜索）
- `idx_manga_favorite`: 收藏状态索引（快速筛选收藏）
- `idx_chapters_manga_id`: 章节的漫画 ID 索引
- `idx_manga_tags_manga_id`: 漫画-标签关联的漫画 ID 索引
- `idx_reading_history_manga_id`: 阅读历史的漫画 ID 索引

---

## 文件扫描器逻辑

### 支持的目录结构

#### 结构 1: 章节目录模式
```
漫画名称/
├── cover.jpg          # 封面（可选）
├── 第1话/
│   ├── 001.jpg
│   └── ...
├── 第2话/
│   └── ...
└── ...
```

#### 结构 2: 单卷模式
```
漫画名称/
├── cover.jpg          # 封面（可选）
├── 001.jpg
├── 002.jpg
└── ...
```

### 扫描逻辑

1. **封面识别**:
   - 优先查找包含 "cover" 或 "封面" 的图片文件
   - 如果没有，使用第一章的第一张图片/或目录下的第一张图片

2. **章节识别**:
   - 扫描所有子目录作为章节
   - 按章节号排序（从文件名提取数字）
   - 如果没有子目录，将整个目录视为单章节

3. **图片识别**:
   - 支持格式: `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`, `.bmp`
   - 按文件名排序

---

## 关键配置说明
- `server/db/init.js`: 核心数据库表结构（WAL 模式开启，支持自动迁移）
- `.env`: 环境变量配置（端口、数据库路径、Library 扫描路径）

