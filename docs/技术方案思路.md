# 技术方案思路 (Technical Proposals)

本文档整理了针对当前系统存在的局限性问题的改建思路与技术方案，重点关注工程化脚本、配置管理、移动端适配以及用户系统。

---

## 1. 工程化脚本增强方案

### 问题现状
目前的 `scripts/dev.ps1` 和 `scripts/prod.ps1` 脚本中硬编码了端口号 (3000, 5173)，一旦用户修改 `.env` 中的端口配置，脚本将无法正确清理进程或检测服务状态。

### 解决方案
利用 PowerShell/Shell 脚本动态解析配置文件。

#### 核心逻辑
1. **配置读取器**: 编写一个通用的函数 `Get-EnvVariable`，用于解析 `.env` 文件每一行，提取 Key-Value 对。
2. **动态端口获取**:
   - `PORT`: 后端端口（默认 3000）
   - `VITE_PORT`: 前端端口（需新增环境变量支持，默认 5173）
3. **流程优化**:
   - 脚本启动时优先读取 `.env`。
   - 使用读取到的端口号执行 `Stop-PortProcess`。
   - 启动命令传递环境变量，确保 `vite` 和 `server` 使用脚本获取到的同一套端口。
   - 实现端口冲突检测与自动杀进程。

---

## 2. 配置管理与回写 (.env Writeback)

### 问题现状
前端缺少"设置"页面，无法修改系统参数（如书库路径、端口、数据库位置）。用户希望在 UI 上修改配置并回写，但 `.env` 通常被视为静态只读文件。

### 架构方案：混合配置模型 (Hybrid Config Model)

为了兼顾**便携性**（所有配置在一个文件夹内）和**开发便利性**，建议采用分层配置策略。

#### A. 配置文件层级
1. **.env (只读/启动项)**: 仅存储启动服务必须的"元配置"（如 `HOST`, `PORT`, `DATA_DIR`）。通常由开发者或部署脚本生成，不建议频繁回写。
2. **system.json (动态/运行时)**: 存储应用级配置（如书库路径列表、扫描策略、UI偏好）。存储在 `DATA_DIR` (如 `./data/config/system.json`) 下。
3. **用户数据库 (settings 表)**: 存储用户级偏好（如最后阅读位置、深色模式状态）。

#### B. 配置回写流程 (Settings API)
如果用户坚持要修改 `.env` (例如修改端口)，则需要极其谨慎的实现：

1. **API 设计**: POST `/api/admin/settings/env`
2. **安全措施**: 仅允许在 Localhost 或通过鉴权后调用。
3. **实现逻辑**:
   - 读取 `.env` 内容为字符串。
   - 使用正则替换目标 Key 的 Value。
   - 写入文件。
   - **重启触发**: 修改 `.env` 后通常需要重启服务才能生效。后端应返回 flag 提示前端"配置已保存，请重启服务"。

*建议优先将非启动类配置迁移到 SQLite `settings` 表或 `json` 文件，实现热更新而无需重启。*

---

## 3. 移动端适配修复 (Mobile Refactor)

### 问题现状
手机端布局错乱，交互无法使用。

### 修复方案
采用 "Mobile First" 策略重构 CSS。

1. **视口锁定**: 确保 `index.html` 包含 `viewport-fit=cover` 和禁止缩放设置。
2. **布局重构**:
   - **SideBar**: 移动端改为底部 TabBar 或 汉堡菜单 (Hamburger Menu) 抽屉式导航。
   - **Grid System**: 漫画卡片在移动端强制 `grid-cols-2` 或 `grid-cols-3`，而非自适应过宽。
3. **触摸交互**:
   - 阅读器引入 `Hammer.js` 或自定义 Touch 事件处理器。
   - 支持左滑下一页、右滑上一页、双击放大。
5. **图片访问适配**:
   - 解决移动端无法访问 `file://` 或本地绝对路径的问题。
   - 所有图片资源统一通过 `/api/image?path=` 接口代理访问。
   - 后端返回相对路径，前端拼接 API 地址。

---


---

## 4. 主题切换与 UI 灵动性 (Theme & UX)

### 问题现状
目前 UI 强制锁定在黑夜模式，缺乏明亮模式支持。整体交互生硬，缺乏反馈。

### 优化方案
1. **主题切换 (Theming)**:
   - 移除 `html` 标签硬编码的 `dark` 类。
   - 实现 `ThemeContext` 或 `Store`，支持 `light`, `dark`, `system` 三种模式。
   - 使用 CSS 变量 (Variables) 重新定义颜色令牌 (Design Tokens)，如 `--bg-primary`, `--text-primary`，利用 Tailwind 的 `@apply` 或 `dark:` 前缀进行精细化适配。

2. **微交互 (Micro-interactions)**:
   - **触觉反馈**: 按钮点击增加 `active:scale-95` 缩放效果。
   - **加载状态**: 使用 **骨架屏 (Skeleton Screens)** 替代单纯的 Loading 圈，提升感知速度。
   - **平滑过渡**: 页面切换引入 `Framer Motion` 或原生 `View Transitions API`。
   - **悬停特效**: 封面卡片增加光影流光效果 (Glassmorphism Shine)。

---

## 5. 性能优化 (Performance)

### 问题现状
漫画库数量增多后，DOM 节点急剧增加，导致页面卡顿。

### 解决方案
1. **虚拟列表 (Virtualization)**:
   - 引入 `react-window` (或原生 JS 实现) 仅渲染可视区域内的漫画卡片。
   - 对于瀑布流布局，采用 `Masonry` 布局即时计算位置。
2. **按需加载 (Lazy Loading)**:
   - **图片**: 只有进入视口 `rootMargin` 范围才开始请求图片资源。
   - **路由**: 对设置页、详情页进行 Code Splitting (Vite 默认支持)。
3. **数据分页 (Pagination/Infinite Scroll)**:
   - 后端 API 支持 `page` 和 `limit` 参数。
   - 前端集成 `IntersectionObserver` 触底自动加载下一页数据。

---

## 6. PIN 码认证系统 (PIN Authentication)

### 使用场景
家庭/个人使用环境，无需复杂的多用户系统，仅需简单的访问控制防止误操作或未授权访问。

### 方案：轻量级 PIN 码认证

#### A. 核心特性
1. **简单配置**: 在 `.env` 或 `config.json` 中设置 4-8 位 PIN 码
2. **可选启用**: 默认关闭，用户可在设置中启用/禁用
3. **会话保持**: 验证通过后在本地存储 session token，有效期可配置（默认 24 小时）
4. **无需注册**: 无用户名、密码等复杂概念，仅需记住 PIN 码

#### B. 技术实现

**配置项** (`.env` 或 `config.json`):
```env
# PIN 码认证配置
PIN_ENABLED=false              # 是否启用 PIN 认证
PIN_CODE=1234                  # PIN 码（4-8位数字）
PIN_SESSION_HOURS=24           # 会话有效期（小时）
```

**数据模型** (settings 表):
```sql
-- 存储 PIN 配置和会话信息
INSERT INTO settings (key, value) VALUES 
  ('pin_enabled', 'false'),
  ('pin_code_hash', ''),  -- bcrypt 哈希后的 PIN 码
  ('pin_session_hours', '24');
```

**认证流程**:
1. 前端访问时检查是否启用 PIN 认证
2. 如启用且无有效 session，显示 PIN 输入框
3. 用户输入 PIN，后端验证并返回 session token
4. 前端存储 token，后续请求携带 token
5. Token 过期后重新验证

**API 设计**:
- `GET /api/auth/status` - 检查认证状态
- `POST /api/auth/verify` - 验证 PIN 码
- `POST /api/auth/logout` - 登出（清除 session）
- `PUT /api/auth/pin` - 修改 PIN 码（需先验证旧 PIN）
- `PUT /api/auth/settings` - 启用/禁用 PIN 认证

#### C. 安全考虑
1. **哈希存储**: PIN 码使用 bcrypt 加密存储，不保存明文
2. **防暴力破解**: 连续 5 次错误后锁定 15 分钟
3. **HTTPS 建议**: 生产环境建议使用 HTTPS 防止中间人攻击
4. **本地存储**: Session token 存储在 localStorage，仅在本地网络使用

---

## 📅 实施路线建议

1. **P0 (已完成)**: 修复移动端布局，确保手机可读。
2. **P1 (已完成)**: 脚本工程化优化，防止端口变动导致服务挂死。
3. **P2 (进行中)**: 实现设置页面及配置回写逻辑 (推荐优先实现 SQLite 存储配置)。
4. **P3 (低)**: 黑夜模式与用户系统。
