<#
.SYNOPSIS
    Pica Manga Development Startup Script
    ä¼˜é›…åœ°å¯åŠ¨å¼€å‘ç¯å¢ƒï¼šæ¸…ç†æ—§è¿›ç¨‹ -> æ£€æŸ¥ç¯å¢ƒ -> å¯åŠ¨æœåŠ¡

.DESCRIPTION
    æ­¤è„šæœ¬ç”¨äºå¯åŠ¨ Pica Manga çš„å¼€å‘ç¯å¢ƒã€‚
    å®ƒä¼šè‡ªåŠ¨æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š
    1. æ£€æŸ¥å¹¶ç»ˆæ­¢å ç”¨ç«¯å£ (3000, 5173) çš„æ—§è¿›ç¨‹ã€‚
    2. æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ä» .env.example åˆ›å»ºï¼Œå¹¶è‡ªåŠ¨é…ç½®å±€åŸŸç½‘IPã€‚
    3. è·å–å¹¶æ˜¾ç¤ºæœ¬æœºå±€åŸŸç½‘ IP åœ°å€ï¼Œæ–¹ä¾¿æ‰‹æœºè®¿é—®ã€‚
    4. ä½¿ç”¨ concurrently å¹¶è¡Œå¯åŠ¨å‰ç«¯ (Vite) å’Œåç«¯ (Nodemon)ã€‚

.EXAMPLE
    ./scripts/dev.ps1
#>

# è®¾ç½®é”™è¯¯å¤„ç†ï¼šé‡åˆ°é”™è¯¯ç»§ç»­ï¼Œä½†ä¼šæŠ¥é”™ï¼ˆä¸ºäº†è¿›ç¨‹æ¸…ç†ï¼‰
$ErrorActionPreference = "Continue"

Write-Host "`nğŸš€ æ­£åœ¨å¯åŠ¨ Pica Manga å¼€å‘ç¯å¢ƒ..." -ForegroundColor Cyan

# ---------------------------------------------------------
# 1. è¿›ç¨‹æ¸…ç†å‡½æ•°
# ---------------------------------------------------------
function Stop-PortProcess {
    param (
        [int]$Port,
        [string]$Name
    )
    
    $process = Get-NetTCPConnection -LocalPort $Port -ErrorAction SilentlyContinue | Select-Object -ExpandProperty OwningProcess -Unique
    if ($process) {
        Write-Host "   Creating clean slate... Killing process on port $Port ($Name)" -ForegroundColor Yellow
        Stop-Process -Id $process -Force -ErrorAction SilentlyContinue
    }
}

Write-Host "ğŸ§¹ æ¸…ç†æ—§è¿›ç¨‹..." -ForegroundColor Green
Stop-PortProcess -Port 3000 -Name "Backend"
Stop-PortProcess -Port 5173 -Name "Frontend"

# ---------------------------------------------------------
# 2. ç¯å¢ƒé…ç½®æ£€æŸ¥
# ---------------------------------------------------------
$EnvFile = Join-Path $PSScriptRoot "..\.env"
$ExampleFile = Join-Path $PSScriptRoot "..\.env.example"

if (-not (Test-Path $EnvFile)) {
    Write-Host "ğŸ“ .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨ä»æ¨¡æ¿åˆ›å»º..." -ForegroundColor Yellow
    Copy-Item $ExampleFile $EnvFile
    
    # è‡ªåŠ¨è¿½åŠ  HOST=0.0.0.0 (å¦‚æœæ¨¡æ¿é‡Œæ²¡æœ‰)
    $EnvContent = Get-Content $EnvFile
    if ($EnvContent -notmatch "HOST=") {
        Add-Content -Path $EnvFile -Value "`n# Generated by dev script`nHOST=0.0.0.0"
    }
    Write-Host "âœ… .env æ–‡ä»¶å·²åˆ›å»ºã€‚" -ForegroundColor Green
} else {
    # æ£€æŸ¥ç°æœ‰çš„ .env æ˜¯å¦é…ç½®äº† Host
    $Content = Get-Content $EnvFile
    if ($Content -notmatch "HOST=0.0.0.0") {
         Write-Host "âš ï¸  æç¤º: å»ºè®®åœ¨ .env ä¸­è®¾ç½® HOST=0.0.0.0 ä»¥å…è®¸å±€åŸŸç½‘è®¿é—®" -ForegroundColor DarkGray
    }
}

# ---------------------------------------------------------
# 3. è·å–å±€åŸŸç½‘ IP
# ---------------------------------------------------------
$IP = Get-NetIPAddress -AddressFamily IPv4 -InterfaceAlias "Wi-Fi","Ethernet","WLAN" -ErrorAction SilentlyContinue | 
      Where-Object { $_.IPAddress -like "192.168.*" -or $_.IPAddress -like "10.*" } | 
      Select-Object -ExpandProperty IPAddress -First 1

if (-not $IP) {
    # Fallback just in case
    $IP = "localhost"
}

# ---------------------------------------------------------
# 4. å¯åŠ¨æœåŠ¡
# ---------------------------------------------------------
Write-Host "`nâœ¨ ç¯å¢ƒå‡†å¤‡å°±ç»ª!" -ForegroundColor Green
Write-Host "   ğŸ“± å±€åŸŸç½‘è®¿é—®åœ°å€ (åç«¯): http://$($IP):3000" -ForegroundColor Cyan
Write-Host "   ğŸ¨ å±€åŸŸç½‘è®¿é—®åœ°å€ (å‰ç«¯): http://$($IP):5173" -ForegroundColor Cyan
Write-Host "   âŒ¨ï¸  æ­£åœ¨å¯åŠ¨æœåŠ¡ (Ctrl+C åœæ­¢)...`n" -ForegroundColor Gray

# ä½¿ç”¨ pnpm start å¯åŠ¨
# æ³¨æ„ï¼šå‰ææ˜¯ package.json ä¸­ start è„šæœ¬ä½¿ç”¨çš„æ˜¯ concurrently
Set-Location -Path (Join-Path $PSScriptRoot "..")
pnpm start
